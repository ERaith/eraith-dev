# ============================================================================
# AI TEST GENERATION WORKFLOW
# ============================================================================
#
# Calls the reusable workflow from ai-test-agents-lab.
# All logic lives there - this is just the trigger.
#
# Setup:
#   1. Add secrets: ANTHROPIC_API_KEY, AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY
#   2. Add variable: S3_BUCKET
#   3. Create labels: generate-tests, approve-plan, approve-cases, tests-generated
#
# ============================================================================

name: Generate Tests

on:
  pull_request:
    types: [labeled]

permissions:
  contents: write
  pull-requests: write

jobs:
  phase-1-plan:
    if: github.event.label.name == 'generate-tests'
    uses: ERaith/ai-test-agents-lab/.github/workflows/test-generation-reusable.yml@main
    with:
      phase: plan
      story_id: pr-${{ github.event.pull_request.number }}
      story_content: |
        # ${{ github.event.pull_request.title }}

        ${{ github.event.pull_request.body }}
      s3_bucket: ${{ vars.S3_BUCKET }}
      s3_prefix: ${{ github.repository }}/pr-${{ github.event.pull_request.number }}
      caller_repo: ${{ github.repository }}
      pr_number: ${{ github.event.pull_request.number }}
      trigger_label: generate-tests
    secrets:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      CALLER_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  phase-2-cases:
    if: github.event.label.name == 'approve-plan'
    uses: ERaith/ai-test-agents-lab/.github/workflows/test-generation-reusable.yml@main
    with:
      phase: cases
      story_id: pr-${{ github.event.pull_request.number }}
      story_content: |
        # ${{ github.event.pull_request.title }}

        ${{ github.event.pull_request.body }}
      s3_bucket: ${{ vars.S3_BUCKET }}
      s3_prefix: ${{ github.repository }}/pr-${{ github.event.pull_request.number }}
      caller_repo: ${{ github.repository }}
      pr_number: ${{ github.event.pull_request.number }}
      trigger_label: approve-plan
    secrets:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      CALLER_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  phase-3-code:
    if: github.event.label.name == 'approve-cases'
    uses: ERaith/ai-test-agents-lab/.github/workflows/test-generation-reusable.yml@main
    with:
      phase: code
      story_id: pr-${{ github.event.pull_request.number }}
      story_content: |
        # ${{ github.event.pull_request.title }}

        ${{ github.event.pull_request.body }}
      s3_bucket: ${{ vars.S3_BUCKET }}
      s3_prefix: ${{ github.repository }}/pr-${{ github.event.pull_request.number }}
      caller_repo: ${{ github.repository }}
      pr_number: ${{ github.event.pull_request.number }}
      pr_head_ref: ${{ github.head_ref }}
      trigger_label: approve-cases
    secrets:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      CALLER_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
