# ============================================================================
# AI TEST GENERATION WORKFLOW (Target Repository)
# ============================================================================
#
# This workflow triggers AI-powered test generation from your central
# ai-test-agents-lab repository.
#
# Flow (label-based):
#   1. Add label "generate-tests" ‚Üí Phase 1: Generate Plan (saved to S3)
#   2. Add label "approve-plan"   ‚Üí Phase 2: Generate Scenarios (saved to S3)
#   3. Add label "approve-cases"  ‚Üí Phase 3: Generate Code (committed to PR)
#
# Artifacts are stored in S3 at: {bucket}/{repo}/pr-{number}/{commit}/
# Only the final test code is committed to the PR branch.
#
# Setup:
#   1. Update TEST_AGENTS_REPO to point to your ai-test-agents-lab fork
#   2. Add secrets: ANTHROPIC_API_KEY, AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY
#   3. Add variable: S3_BUCKET
#   4. Create labels: generate-tests, approve-plan, approve-cases, tests-generated
#
# ============================================================================

name: Generate Tests

on:
  pull_request:
    types: [labeled]

permissions:
  contents: write
  pull-requests: write

env:
  # TODO: Update this to your organization's ai-test-agents-lab repository
  TEST_AGENTS_REPO: ERaith/ai-test-agents-lab

jobs:
  # ==========================================================================
  # Phase 1: Generate Test Plan
  # ==========================================================================
  phase-1-plan:
    name: "üìù Phase 1: Generate Test Plan"
    runs-on: ubuntu-latest
    if: github.event.label.name == 'generate-tests'

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Checkout ai-test-agents-lab
        uses: actions/checkout@v4
        with:
          repository: ${{ env.TEST_AGENTS_REPO }}
          path: .ai-agents
          ref: main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install agent dependencies
        run: npm ci
        working-directory: .ai-agents

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: Setup paths
        id: paths
        run: |
          PR_NUM="${{ github.event.pull_request.number }}"
          COMMIT="${{ github.event.pull_request.head.sha }}"
          SHORT_COMMIT="${COMMIT:0:7}"
          S3_PREFIX="${{ github.repository }}/pr-${PR_NUM}/${SHORT_COMMIT}"

          echo "story_id=pr-${PR_NUM}" >> $GITHUB_OUTPUT
          echo "pr_number=${PR_NUM}" >> $GITHUB_OUTPUT
          echo "commit=${SHORT_COMMIT}" >> $GITHUB_OUTPUT
          echo "s3_prefix=${S3_PREFIX}" >> $GITHUB_OUTPUT

      - name: Load previous context from S3
        run: |
          # Load cross-PR memory/context
          aws s3 sync "s3://${{ vars.S3_BUCKET }}/${{ github.repository }}/memory/" ".ai-agents/memory/" --quiet || true
          aws s3 sync "s3://${{ vars.S3_BUCKET }}/${{ github.repository }}/context/" ".ai-agents/context/" --quiet || true
          echo "Loaded context from S3"

      - name: Extract story from PR
        run: |
          mkdir -p .ai-agents/specs
          cat > ".ai-agents/specs/${{ steps.paths.outputs.story_id }}.md" << 'EOF'
          # ${{ github.event.pull_request.title }}

          ${{ github.event.pull_request.body }}
          EOF

      - name: Save PR diff
        run: |
          mkdir -p ".ai-agents/test-artifacts/${{ steps.paths.outputs.story_id }}"
          git diff origin/${{ github.event.pull_request.base.ref }}...HEAD > ".ai-agents/test-artifacts/${{ steps.paths.outputs.story_id }}/pr.diff" || true

      - name: Generate test plan
        run: npx tsx src/cli.ts plan ${{ steps.paths.outputs.story_id }} --skip-approval
        working-directory: .ai-agents
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Save artifacts to S3
        run: |
          # Save this PR's artifacts
          aws s3 sync ".ai-agents/test-artifacts/${{ steps.paths.outputs.story_id }}/" \
            "s3://${{ vars.S3_BUCKET }}/${{ steps.paths.outputs.s3_prefix }}/artifacts/" --quiet

          # Update cross-PR memory
          aws s3 sync ".ai-agents/memory/" \
            "s3://${{ vars.S3_BUCKET }}/${{ github.repository }}/memory/" --quiet || true

          echo "Saved artifacts to s3://${{ vars.S3_BUCKET }}/${{ steps.paths.outputs.s3_prefix }}/"

      - name: Post plan comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const storyId = '${{ steps.paths.outputs.story_id }}';
            const prNumber = ${{ steps.paths.outputs.pr_number }};
            const s3Path = '${{ steps.paths.outputs.s3_prefix }}';
            const plan = fs.readFileSync(`.ai-agents/test-artifacts/${storyId}/test-plan.md`, 'utf8');
            const content = plan.length > 60000 ? plan.substring(0, 60000) + '\n...(truncated)' : plan;

            const body = `## üìù Phase 1: Test Plan

            <details>
            <summary>Click to expand</summary>

            ${content}

            </details>

            ---
            üì¶ Artifacts saved to S3: \`${s3Path}/\`

            **Next:** Add label \`approve-plan\` to continue to Phase 2`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

      - name: Update labels
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.paths.outputs.pr_number }};
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              name: 'generate-tests'
            }).catch(() => {});

  # ==========================================================================
  # Phase 2: Generate Gherkin Scenarios
  # ==========================================================================
  phase-2-cases:
    name: "ü•í Phase 2: Generate Scenarios"
    runs-on: ubuntu-latest
    if: github.event.label.name == 'approve-plan'

    steps:
      - name: Checkout ai-test-agents-lab
        uses: actions/checkout@v4
        with:
          repository: ${{ env.TEST_AGENTS_REPO }}
          path: .ai-agents
          ref: main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install agent dependencies
        run: npm ci
        working-directory: .ai-agents

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: Setup paths
        id: paths
        run: |
          PR_NUM="${{ github.event.pull_request.number }}"
          COMMIT="${{ github.event.pull_request.head.sha }}"
          SHORT_COMMIT="${COMMIT:0:7}"
          S3_PREFIX="${{ github.repository }}/pr-${PR_NUM}/${SHORT_COMMIT}"

          echo "story_id=pr-${PR_NUM}" >> $GITHUB_OUTPUT
          echo "pr_number=${PR_NUM}" >> $GITHUB_OUTPUT
          echo "s3_prefix=${S3_PREFIX}" >> $GITHUB_OUTPUT

      - name: Load artifacts from S3
        run: |
          mkdir -p ".ai-agents/test-artifacts/${{ steps.paths.outputs.story_id }}"
          aws s3 sync "s3://${{ vars.S3_BUCKET }}/${{ steps.paths.outputs.s3_prefix }}/artifacts/" \
            ".ai-agents/test-artifacts/${{ steps.paths.outputs.story_id }}/" --quiet

          if [ ! -f ".ai-agents/test-artifacts/${{ steps.paths.outputs.story_id }}/test-plan.md" ]; then
            echo "‚ùå Test plan not found in S3. Add 'generate-tests' label first."
            exit 1
          fi
          echo "‚úÖ Loaded artifacts from S3"

      - name: Generate scenarios
        run: npx tsx src/cli.ts cases ${{ steps.paths.outputs.story_id }} --skip-approval
        working-directory: .ai-agents
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Save artifacts to S3
        run: |
          aws s3 sync ".ai-agents/test-artifacts/${{ steps.paths.outputs.story_id }}/" \
            "s3://${{ vars.S3_BUCKET }}/${{ steps.paths.outputs.s3_prefix }}/artifacts/" --quiet
          echo "Saved scenarios to S3"

      - name: Post scenarios comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const storyId = '${{ steps.paths.outputs.story_id }}';
            const prNumber = ${{ steps.paths.outputs.pr_number }};
            const s3Path = '${{ steps.paths.outputs.s3_prefix }}';
            const scenarios = fs.readFileSync(`.ai-agents/test-artifacts/${storyId}/scenarios.feature`, 'utf8');
            const content = scenarios.length > 60000 ? scenarios.substring(0, 60000) + '\n...(truncated)' : scenarios;

            const body = `## ü•í Phase 2: Gherkin Scenarios

            <details>
            <summary>Click to expand</summary>

            \`\`\`gherkin
            ${content}
            \`\`\`

            </details>

            ---
            üì¶ Artifacts saved to S3: \`${s3Path}/\`

            **Next:** Add label \`approve-cases\` to continue to Phase 3`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

      - name: Update labels
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.paths.outputs.pr_number }};
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              name: 'approve-plan'
            }).catch(() => {});

  # ==========================================================================
  # Phase 3: Generate Test Code (commits to PR)
  # ==========================================================================
  phase-3-code:
    name: "üíª Phase 3: Generate Tests"
    runs-on: ubuntu-latest
    if: github.event.label.name == 'approve-cases'

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout ai-test-agents-lab
        uses: actions/checkout@v4
        with:
          repository: ${{ env.TEST_AGENTS_REPO }}
          path: .ai-agents
          ref: main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install agent dependencies
        run: npm ci
        working-directory: .ai-agents

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: Setup paths
        id: paths
        run: |
          PR_NUM="${{ github.event.pull_request.number }}"
          COMMIT="${{ github.event.pull_request.head.sha }}"
          SHORT_COMMIT="${COMMIT:0:7}"
          S3_PREFIX="${{ github.repository }}/pr-${PR_NUM}/${SHORT_COMMIT}"

          echo "story_id=pr-${PR_NUM}" >> $GITHUB_OUTPUT
          echo "pr_number=${PR_NUM}" >> $GITHUB_OUTPUT
          echo "s3_prefix=${S3_PREFIX}" >> $GITHUB_OUTPUT

      - name: Load artifacts from S3
        run: |
          mkdir -p ".ai-agents/test-artifacts/${{ steps.paths.outputs.story_id }}"
          aws s3 sync "s3://${{ vars.S3_BUCKET }}/${{ steps.paths.outputs.s3_prefix }}/artifacts/" \
            ".ai-agents/test-artifacts/${{ steps.paths.outputs.story_id }}/" --quiet

          if [ ! -f ".ai-agents/test-artifacts/${{ steps.paths.outputs.story_id }}/scenarios.feature" ]; then
            echo "‚ùå Scenarios not found in S3. Add 'approve-plan' label first."
            exit 1
          fi
          echo "‚úÖ Loaded artifacts from S3"

      - name: Generate test code
        run: npx tsx src/cli.ts code ${{ steps.paths.outputs.story_id }} --skip-approval
        working-directory: .ai-agents
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Copy test code to repo
        run: |
          mkdir -p playwright/tests
          cp .ai-agents/playwright/tests/${{ steps.paths.outputs.story_id }}.spec.ts playwright/tests/

      - name: Commit test code
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add playwright/
          git commit -m "ü§ñ Add generated Playwright tests for PR #${{ steps.paths.outputs.pr_number }}"
          git push

      - name: Save final artifacts to S3
        run: |
          # Save generated code to S3 as well
          aws s3 cp ".ai-agents/playwright/tests/${{ steps.paths.outputs.story_id }}.spec.ts" \
            "s3://${{ vars.S3_BUCKET }}/${{ steps.paths.outputs.s3_prefix }}/artifacts/test-code.spec.ts" --quiet

          # Update cross-PR memory with this successful generation
          aws s3 sync ".ai-agents/memory/" \
            "s3://${{ vars.S3_BUCKET }}/${{ github.repository }}/memory/" --quiet || true

      - name: Post completion comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const storyId = '${{ steps.paths.outputs.story_id }}';
            const prNumber = ${{ steps.paths.outputs.pr_number }};
            const s3Path = '${{ steps.paths.outputs.s3_prefix }}';
            const testFile = `playwright/tests/${storyId}.spec.ts`;
            const code = fs.readFileSync(testFile, 'utf8');
            const preview = code.split('\n').slice(0, 50).join('\n');

            const body = `## üíª Phase 3: Test Code

            ‚úÖ **All phases complete!** Test code committed to this PR.

            <details>
            <summary>Click to expand code</summary>

            \`\`\`typescript
            ${preview}
            \`\`\`

            </details>

            ### Generated Files
            - \`${testFile}\` (committed to PR)

            ### Artifacts in S3
            - \`${s3Path}/artifacts/test-plan.md\`
            - \`${s3Path}/artifacts/scenarios.feature\`
            - \`${s3Path}/artifacts/test-code.spec.ts\`

            **Next:** Pull changes, review, and merge!`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

      - name: Update labels
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.paths.outputs.pr_number }};
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              name: 'approve-cases'
            }).catch(() => {});

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: ['tests-generated']
            });
